action:
  - choose:
      # ====================================================================
      # DÉTECTEUR DE MOUVEMENT - INCHANGÉ
      # ====================================================================
      - conditions:
          - condition: trigger
            id: motion_detected
          - condition: template
            value_template: "{{ motion_valid }}"
          - condition: template
            value_template: "{{ auto_mode_valid }}"
          - condition: state
            entity_id: !input auto_mode_boolean
            state: "on"
        sequence:
          # ... (garder la séquence existante)
      
      # ====================================================================
      # BOUTON - SIMPLE CLIC - CORRIGÉ
      # ====================================================================
      - conditions:
          - condition: trigger
            id: button_pressed
          - condition: template
            value_template: "{{ button_valid }}"
          - condition: template
            value_template: "{{ button_event_type == event_single }}"
        sequence:
          # Marquer comme allumé manuellement
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input lighting_source_boolean
          
          # Annuler minuterie auto si active
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto
          
          # Toggle lumière
          - choose:
              # Si éteinte → allumer
              - conditions:
                  - condition: state
                    entity_id: !input light_entity
                    state: "off"
                sequence:
                  - action: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data:
                      brightness_pct: "{{ bright_single }}"
                      transition: "{{ trans_on }}"
                  
                  # Démarrer minuterie manuelle SI définie
                  - if:
                      - condition: template
                        value_template: "{{ timer_manual_valid }}"
                    then:
                      - action: timer.start
                        target:
                          entity_id: !input timer_manual
            
            # Sinon → éteindre
            default:
              - action: light.turn_off
                target:
                  entity_id: !input light_entity
                data:
                  transition: "{{ trans_off_manual }}"
              
              # Annuler minuterie manuelle SI définie
              - if:
                  - condition: template
                    value_template: "{{ timer_manual_valid }}"
                then:
                  - action: timer.cancel
                    target:
                      entity_id: !input timer_manual
      
      # ====================================================================
      # BOUTON - DOUBLE CLIC - CORRIGÉ
      # ====================================================================
      - conditions:
          - condition: trigger
            id: button_pressed
          - condition: template
            value_template: "{{ button_valid }}"
          - condition: template
            value_template: "{{ button_event_type == event_double }}"
        sequence:
          # Marquer comme allumé manuellement
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input lighting_source_boolean
          
          # Annuler minuterie auto
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto
          
          # Allumer à pleine puissance
          - action: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: "{{ bright_double }}"
              transition: "{{ trans_on }}"
          
          # Démarrer minuterie manuelle SI définie
          - if:
              - condition: template
                value_template: "{{ timer_manual_valid }}"
            then:
              - action: timer.start
                target:
                  entity_id: !input timer_manual
      
      # ====================================================================
      # BOUTON - TRIPLE CLIC - CORRIGÉ
      # ====================================================================
      - conditions:
          - condition: trigger
            id: button_pressed
          - condition: template
            value_template: "{{ button_valid }}"
          - condition: template
            value_template: "{{ button_event_type == event_triple }}"
        sequence:
          # Marquer comme allumé manuellement
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input lighting_source_boolean
          
          # Annuler minuterie auto
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto
          
          # Allumer en mode veilleuse
          - action: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: "{{ bright_triple }}"
              transition: "{{ trans_on }}"
          
          # Démarrer minuterie manuelle SI définie
          - if:
              - condition: template
                value_template: "{{ timer_manual_valid }}"
            then:
              - action: timer.start
                target:
                  entity_id: !input timer_manual
      
      # ====================================================================
      # BOUTON - APPUI LONG (DIMMER) - CORRIGÉ
      # ====================================================================
      - conditions:
          - condition: trigger
            id: button_pressed
          - condition: template
            value_template: "{{ button_valid }}"
          - condition: template
            value_template: "{{ button_event_type == event_long }}"
        sequence:
          # Annuler les minuteries
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto
          
          - if:
              - condition: template
                value_template: "{{ timer_manual_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_manual
          
          # Dimmer progressif jusqu'au minimum ou relâchement
          - repeat:
              while:
                - condition: template
                  value_template: "{{ state_attr(button_entity, 'event_type') == event_long }}"
                - condition: template
                  value_template: "{{ (state_attr(light, 'brightness') | int(0) / 2.55) | int(0) > bright_min }}"
              sequence:
                - action: light.turn_on
                  target:
                    entity_id: !input light_entity
                  data:
                    brightness_step_pct: "{{ -dim_step }}"
                
                - delay:
                    seconds: "{{ dim_interval }}"
          
          # Si luminosité minimale atteinte → éteindre
          - if:
              - condition: template
                value_template: "{{ (state_attr(light, 'brightness') | int(0) / 2.55) | int(0) <= bright_min }}"
            then:
              - action: light.turn_off
                target:
                  entity_id: !input light_entity
                data:
                  transition: "{{ trans_off_manual }}"
      
      # ====================================================================
      # FIN MINUTERIE MANUELLE - INCHANGÉ
      # ====================================================================
      - conditions:
          - condition: trigger
            id: timer_manual_finished
          - condition: template
            value_template: "{{ timer_manual_valid }}"
        sequence:
          - action: light.turn_off
            target:
              entity_id: !input light_entity
            data:
              transition: "{{ trans_off_auto }}"
      
      # ====================================================================
      # FIN MINUTERIE AUTOMATIQUE - INCHANGÉ
      # ====================================================================
      - conditions:
          - condition: trigger
            id: timer_auto_finished
          - condition: template
            value_template: "{{ timer_auto_valid }}"
        sequence:
          - condition: template
            value_template: "{{ source_bool_valid }}"
          
          - condition: state
            entity_id: !input lighting_source_boolean
            state: "on"
          
          - action: light.turn_off
            target:
              entity_id: !input light_entity
            data:
              transition: "{{ trans_off_auto }}"
