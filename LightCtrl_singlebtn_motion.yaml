blueprint:
  name: √âclairage intelligent avec d√©tecteur et bouton (v2.1)
  description: >
    G√®re l'√©clairage d'une pi√®ce avec :
    - Contr√¥le manuel par bouton (marche/arr√™t, dimmer, multi-press avec luminosit√©s personnalis√©es)
    - D√©tection automatique de mouvement (modes jour/nuit avec luminosit√©s diff√©rentes)
    - Minuteries auto/manuelle avec gestion intelligente
    - Mode automatique activable/d√©sactivable
    - Suivi de l'origine de l'allumage (d√©tecteur vs manuel)
  domain: automation
  
  input:
    # ========================================
    # ENTIT√âS PRINCIPALES
    # ========================================
    button_event:
      name: Bouton de contr√¥le
      description: Event entity du bouton (ex. IKEA Somrig)
      selector:
        entity:
          filter:
            - domain: event
    
    light_entity:
      name: Lumi√®re
      description: La lumi√®re √† contr√¥ler
      selector:
        entity:
          filter:
            - domain: light
    
    motion_sensor:
      name: D√©tecteur de mouvement
      description: Capteur binaire de pr√©sence ou de mouvement
      selector:
        entity:
          filter:
            - domain: binary_sensor
              device_class: 
                - occupancy
                - motion
    
    auto_mode_boolean:
      name: Autorisation mode automatique
      description: Input boolean pour autoriser/interdire la d√©tection automatique (ON = Auto autoris√©)
      selector:
        entity:
          filter:
            - domain: input_boolean
    
    lighting_source_boolean:
      name: Source d'allumage
      description: Input boolean indiquant l'origine (ON = D√©tecteur automatique, OFF = Manuel)
      selector:
        entity:
          filter:
            - domain: input_boolean
    
    timer_auto:
      name: Minuterie automatique
      description: Timer pour extinction automatique (d√©tecteur)
      selector:
        entity:
          filter:
            - domain: timer
    
    timer_manual:
      name: Minuterie manuelle
      description: Timer pour extinction manuelle (bouton)
      selector:
        entity:
          filter:
            - domain: timer
    
    # ========================================
    # PARAM√àTRES √âV√âNEMENTS BOUTON
    # ========================================
    button_event_single:
      name: Event simple pression
      description: Nom de l'event pour simple pression
      default: "multi_press_1"
      selector:
        text:
    
    button_event_double:
      name: Event double pression
      description: Nom de l'event pour double pression
      default: "multi_press_2"
      selector:
        text:
    
    button_event_triple:
      name: Event triple pression
      description: Nom de l'event pour triple pression
      default: "multi_press_3"
      selector:
        text:
    
    button_event_long:
      name: Event pression longue
      description: Nom de l'event pour pression longue
      default: "long_press"
      selector:
        text:
    
    # ========================================
    # LUMINOSIT√âS BOUTON
    # ========================================
    brightness_single_click:
      name: "üí° Luminosit√© : 1 clic"
      description: Luminosit√© lors d'un simple clic (%)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
    
    brightness_double_click:
      name: "üí° Luminosit√© : 2 clics"
      description: Luminosit√© lors d'un double clic (%)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
    
    brightness_triple_click:
      name: "üí° Luminosit√© : 3 clics"
      description: Luminosit√© lors d'un triple clic (%)
      default: 1
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
    
    # ========================================
    # LUMINOSIT√âS D√âTECTEUR
    # ========================================
    brightness_detector_night:
      name: "üåô Luminosit√© : D√©tecteur nuit"
      description: Luminosit√© en d√©tection automatique nocturne (%)
      default: 30
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
    
    brightness_detector_day:
      name: "‚òÄÔ∏è Luminosit√© : D√©tecteur jour"
      description: Luminosit√© en d√©tection automatique diurne (%)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
    
    # ========================================
    # MODE D√âTECTION
    # ========================================
    detection_mode:
      name: Mode de d√©tection
      description: Quand activer la d√©tection automatique
      default: night_only
      selector:
        select:
          options:
            - label: "Nuit uniquement"
              value: night_only
            - label: "Jour et nuit"
              value: day_and_night
            - label: "Jour uniquement"
              value: day_only
    
    # ========================================
    # PARAM√àTRES DIMMER
    # ========================================
    brightness_min:
      name: Seuil minimal dimmer
      description: Luminosit√© minimale avant arr√™t du dimmer (0-255)
      default: 11
      selector:
        number:
          min: 0
          max: 255
    
    dimmer_step:
      name: Pas du dimmer
      description: R√©duction par pas en mode long press (%)
      default: 10
      selector:
        number:
          min: 1
          max: 25
          unit_of_measurement: "%"
    
    dimmer_delay:
      name: D√©lai dimmer
      description: D√©lai entre chaque pas du dimmer (ms)
      default: 20
      selector:
        number:
          min: 10
          max: 200
          unit_of_measurement: "ms"
    
    # ========================================
    # TRANSITIONS
    # ========================================
    transition_on:
      name: Transition allumage manuel
      description: Dur√©e transition allumage bouton (secondes)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "s"
    
    transition_off_button:
      name: "‚èπÔ∏è Transition extinction bouton"
      description: Dur√©e transition extinction manuelle par bouton (secondes)
      default: 1
      selector:
        number:
          min: 0
          max: 30
          step: 0.5
          unit_of_measurement: "s"
    
    transition_off_timer:
      name: "‚è±Ô∏è Transition extinction minuterie"
      description: Dur√©e transition extinction automatique par minuterie (secondes)
      default: 5
      selector:
        number:
          min: 0
          max: 30
          step: 0.5
          unit_of_measurement: "s"
    
    transition_detector:
      name: Transition d√©tecteur
      description: Dur√©e transition en mode automatique (secondes)
      default: 2
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "s"
    
    transition_dimmer:
      name: Transition changement luminosit√©
      description: Dur√©e transition lors de changement de luminosit√© (secondes)
      default: 3
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "s"

mode: queued
max: 10

triggers:
  # Trigger 1 : Bouton
  - trigger: state
    entity_id: !input button_event
    id: button
  
  # Trigger 2 : Fin minuterie auto
  - trigger: state
    entity_id: !input timer_auto
    from: active
    to: idle
    id: timer_auto_end
  
  # Trigger 3 : Fin minuterie manuelle
  - trigger: state
    entity_id: !input timer_manual
    from: active
    to: idle
    id: timer_manual_end
  
  # Trigger 4 : D√©tection de mouvement
  - trigger: state
    entity_id: !input motion_sensor
    from: "off"
    to: "on"
    id: motion_detected

variables:
  button_entity: !input button_event
  light: !input light_entity
  motion: !input motion_sensor
  auto_mode_bool: !input auto_mode_boolean
  source_bool: !input lighting_source_boolean
  timer_auto: !input timer_auto
  timer_manual: !input timer_manual
  
  event_single: !input button_event_single
  event_double: !input button_event_double
  event_triple: !input button_event_triple
  event_long: !input button_event_long
  
  bright_single: !input brightness_single_click
  bright_double: !input brightness_double_click
  bright_triple: !input brightness_triple_click
  bright_det_night: !input brightness_detector_night
  bright_det_day: !input brightness_detector_day
  
  detect_mode: !input detection_mode
  
  bright_min: !input brightness_min
  dim_step: !input dimmer_step
  dim_delay: !input dimmer_delay
  
  trans_on: !input transition_on
  trans_off_button: !input transition_off_button
  trans_off_timer: !input transition_off_timer
  trans_detector: !input transition_detector
  trans_dimmer: !input transition_dimmer

actions:
  - choose:
      # ========================================
      # GESTION BOUTON
      # ========================================
      - conditions:
          - condition: trigger
            id: button
        sequence:
          - choose:
              # --- ALLUMAGE SIMPLE CLIC ---
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr(button_entity, 'event_type') == event_single }}"
                  - condition: or
                    conditions:
                      # Cas 1 : Lumi√®re √©teinte
                      - condition: state
                        entity_id: !input light_entity
                        state: "off"
                      # Cas 2 : Lumi√®re allum√©e par d√©tecteur (source = ON)
                      - condition: and
                        conditions:
                          - condition: state
                            entity_id: !input light_entity
                            state: "on"
                          - condition: state
                            entity_id: !input lighting_source_boolean
                            state: "on"
                sequence:
                  # Marquer comme allumage manuel
                  - action: input_boolean.turn_off
                    target:
                      entity_id: !input lighting_source_boolean
                  
                  # Arr√™ter les minuteries
                  - action: timer.finish
                    target:
                      entity_id: 
                        - !input timer_auto
                        - !input timer_manual
                  
                  # Allumer √† la luminosit√© simple clic
                  - action: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data:
                      brightness_pct: "{{ bright_single }}"
                      transition: "{{ trans_on }}"
                  
                  # D√©marrer minuterie manuelle
                  - action: timer.start
                    target:
                      entity_id: !input timer_manual
              
              # --- EXTINCTION SIMPLE CLIC (lumi√®re allum√©e manuellement) ---
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr(button_entity, 'event_type') == event_single }}"
                  - condition: state
                    entity_id: !input lighting_source_boolean
                    state: "off"
                  - condition: state
                    entity_id: !input light_entity
                    state: "on"
                sequence:
                  # Arr√™ter les minuteries
                  - action: timer.finish
                    target:
                      entity_id: 
                        - !input timer_auto
                        - !input timer_manual
                  
                  # √âteindre avec transition bouton
                  - action: light.turn_off
                    target:
                      entity_id: !input light_entity
                    data:
                      transition: "{{ trans_off_button }}"
                  
                  # Petit d√©lai avant r√©activation auto
                  - delay:
                      seconds: 2
              
              # --- DOUBLE CLIC : Luminosit√© personnalis√©e ---
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr(button_entity, 'event_type') == event_double }}"
                sequence:
                  # Si lumi√®re √©teinte : allumer
                  - if:
                      - condition: state
                        entity_id: !input light_entity
                        state: "off"
                    then:
                      # Marquer comme manuel
                      - action: input_boolean.turn_off
                        target:
                          entity_id: !input lighting_source_boolean
                      
                      # Arr√™ter minuteries
                      - action: timer.finish
                        target:
                          entity_id:
                            - !input timer_auto
                            - !input timer_manual
                      
                      # D√©marrer minuterie manuelle
                      - action: timer.start
                        target:
                          entity_id: !input timer_manual
                  
                  # Ajuster luminosit√© (allum√©e ou non)
                  - action: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data:
                      brightness_pct: "{{ bright_double }}"
                      transition: "{{ trans_dimmer }}"
              
              # --- TRIPLE CLIC : Luminosit√© minimale/veilleuse ---
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr(button_entity, 'event_type') == event_triple }}"
                sequence:
                  # Si lumi√®re √©teinte : allumer
                  - if:
                      - condition: state
                        entity_id: !input light_entity
                        state: "off"
                    then:
                      # Marquer comme manuel
                      - action: input_boolean.turn_off
                        target:
                          entity_id: !input lighting_source_boolean
                      
                      # Arr√™ter minuteries
                      - action: timer.finish
                        target:
                          entity_id:
                            - !input timer_auto
                            - !input timer_manual
                      
                      # D√©marrer minuterie manuelle
                      - action: timer.start
                        target:
                          entity_id: !input timer_manual
                  
                  # Ajuster luminosit√© minimale
                  - action: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data:
                      brightness_pct: "{{ bright_triple }}"
                      transition: "{{ trans_dimmer }}"
              
              # --- LONG PRESS : Dimmer progressif ---
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr(button_entity, 'event_type') == event_long }}"
                  - condition: state
                    entity_id: !input light_entity
                    state: "on"
                sequence:
                  - repeat:
                      while:
                        - condition: template
                          value_template: "{{ state_attr(button_entity, 'event_type') == event_long }}"
                        - condition: numeric_state
                          entity_id: !input light_entity
                          attribute: brightness
                          above: "{{ bright_min }}"
                      sequence:
                        - action: light.turn_on
                          target:
                            entity_id: !input light_entity
                          data:
                            brightness_step_pct: "{{ -dim_step }}"
                        
                        - delay:
                            milliseconds: "{{ dim_delay }}"
      
      # ========================================
      # FIN MINUTERIE AUTO (allumage par d√©tecteur)
      # ========================================
      - conditions:
          - condition: trigger
            id: timer_auto_end
          - condition: state
            entity_id: !input lighting_source_boolean
            state: "on"
        sequence:
          - action: light.turn_off
            target:
              entity_id: !input light_entity
            data:
              transition: "{{ trans_off_timer }}"
      
      # ========================================
      # FIN MINUTERIE MANUELLE (allumage manuel)
      # ========================================
      - conditions:
          - condition: trigger
            id: timer_manual_end
          - condition: state
            entity_id: !input lighting_source_boolean
            state: "off"
        sequence:
          - action: light.turn_off
            target:
              entity_id: !input light_entity
            data:
              transition: "{{ trans_off_timer }}"
      
      # ========================================
      # D√âTECTION DE MOUVEMENT
      # ========================================
      - conditions:
          - condition: trigger
            id: motion_detected
        sequence:
          - choose:
              # --- Allumage automatique si autoris√© ---
              - conditions:
                  # Mode auto activ√©
                  - condition: state
                    entity_id: !input auto_mode_boolean
                    state: "on"
                  # Lumi√®re √©teinte
                  - condition: state
                    entity_id: !input light_entity
                    state: "off"
                  # V√©rification p√©riode jour/nuit selon mode
                  - condition: or
                    conditions:
                      # Mode jour et nuit
                      - condition: template
                        value_template: "{{ detect_mode == 'day_and_night' }}"
                      # Mode nuit uniquement + p√©riode nuit
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ detect_mode == 'night_only' }}"
                          - condition: sun
                            before: sunrise
                            after: sunset
                      # Mode jour uniquement + p√©riode jour
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ detect_mode == 'day_only' }}"
                          - condition: sun
                            after: sunrise
                            before: sunset
                sequence:
                  # Marquer comme allumage automatique
                  - action: input_boolean.turn_on
                    target:
                      entity_id: !input lighting_source_boolean
                  
                  # D√©terminer luminosit√© selon p√©riode
                  - choose:
                      # P√©riode nocturne
                      - conditions:
                          - condition: sun
                            before: sunrise
                            after: sunset
                        sequence:
                          - action: light.turn_on
                            target:
                              entity_id: !input light_entity
                            data:
                              brightness_pct: "{{ bright_det_night }}"
                              transition: "{{ trans_detector }}"
                    # Par d√©faut : p√©riode diurne
                    default:
                      - action: light.turn_on
                        target:
                          entity_id: !input light_entity
                        data:
                          brightness_pct: "{{ bright_det_day }}"
                          transition: "{{ trans_detector }}"
                  
                  # D√©marrer minuterie auto
                  - action: timer.start
                    target:
                      entity_id: !input timer_auto
              
              # --- Relance minuterie si lumi√®re allum√©e par d√©tecteur ---
              - conditions:
                  - condition: state
                    entity_id: !input timer_auto
                    state: active
                  - condition: state
                    entity_id: !input lighting_source_boolean
                    state: "on"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: !input timer_auto
              
              # --- Relance minuterie si lumi√®re allum√©e manuellement ---
              - conditions:
                  - condition: state
                    entity_id: !input timer_manual
                    state: active
                  - condition: state
                    entity_id: !input lighting_source_boolean
                    state: "off"
                  - condition: state
                    entity_id: !input light_entity
                    state: "on"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: !input timer_manual
