blueprint:
  name: Ã‰clairage intelligent avec dÃ©tecteur et bouton (v20260215)
  description: >
    GÃ¨re l'Ã©clairage d'une piÃ¨ce avec :
    - ContrÃ´le manuel par bouton OPTIONNEL (marche/arrÃªt, dimmer, multi-press avec luminositÃ©s personnalisÃ©es)
    - DÃ©tection automatique de mouvement OPTIONNELLE (modes jour/nuit basÃ©s sur le lever/coucher du soleil)
    - **NOUVEAU:** Activation conditionnelle du dÃ©tecteur (jamais/jour/nuit/toujours)
    - Minuteries auto/manuelle avec gestion intelligente (utilise les durÃ©es configurÃ©es dans les timers)
    - Mode automatique activable/dÃ©sactivable
    - Suivi de l'origine de l'allumage (dÃ©tecteur vs manuel)
    - Configuration minimale : seulement la lumiÃ¨re est obligatoire
    - Utilisation native des pourcentages pour les luminositÃ©s
    - DÃ©fauts optimisÃ©s : Simple=80%, Double=100%, Triple=11%, Nuit=30min avant sunset, Jour=30min aprÃ¨s sunrise
  domain: automation

  input:
    # ========================================
    # ENTITÃ‰S PRINCIPALES
    # ========================================
    light_entity:
      name: LumiÃ¨re (OBLIGATOIRE)
      description: La lumiÃ¨re Ã  contrÃ´ler
      selector:
        entity:
          filter:
            - domain: light

    button_event:
      name: Bouton de contrÃ´le (optionnel)
      description: Event entity du bouton (ex. IKEA Somrig) - laisser vide pour dÃ©sactiver
      default: {}
      selector:
        entity:
          filter:
            - domain: event

    motion_sensor:
      name: DÃ©tecteur de mouvement (optionnel)
      description: Capteur binaire de prÃ©sence ou de mouvement - laisser vide pour dÃ©sactiver
      default: {}
      selector:
        entity:
          filter:
            - domain: binary_sensor
              device_class: 
                - occupancy
                - motion

    # ========================================
    # ACTIVATION DÃ‰TECTEUR
    # ========================================
    motion_activation_mode:
      name: Mode d'activation du dÃ©tecteur
      description: Quand le dÃ©tecteur de mouvement doit-il fonctionner ?
      default: always
      selector:
        select:
          options:
            - label: "Jamais"
              value: "never"
            - label: "Uniquement le jour"
              value: "day_only"
            - label: "Uniquement la nuit"
              value: "night_only"
            - label: "Toujours"
              value: "always"
          mode: dropdown

    auto_mode_boolean:
      name: Autorisation mode automatique (optionnel)
      description: Input boolean pour autoriser/interdire la dÃ©tection automatique (requis seulement si dÃ©tecteur configurÃ©)
      default: {}
      selector:
        entity:
          filter:
            - domain: input_boolean

    lighting_source_boolean:
      name: Source d'allumage (optionnel)
      description: Input boolean indiquant l'origine - ON=auto, OFF=manuel (requis seulement si dÃ©tecteur ET bouton configurÃ©s)
      default: {}
      selector:
        entity:
          filter:
            - domain: input_boolean

    timer_auto:
      name: Minuterie automatique (optionnel)
      description: Timer pour extinction automatique aprÃ¨s dÃ©tection de mouvement (utilise la durÃ©e configurÃ©e dans le timer)
      default: {}
      selector:
        entity:
          filter:
            - domain: timer

    timer_manual:
      name: Minuterie manuelle (optionnel)
      description: Timer pour extinction manuelle aprÃ¨s allumage par bouton (utilise la durÃ©e configurÃ©e dans le timer)
      default: {}
      selector:
        entity:
          filter:
            - domain: timer

    # ========================================
    # CONFIGURATION BOUTON
    # ========================================
    event_single:
      name: Ã‰vÃ©nement simple clic
      description: Nom de l'Ã©vÃ©nement pour un simple clic (ex. "single" ou "1_single")
      default: "single"
      selector:
        text:

    event_double:
      name: Ã‰vÃ©nement double clic
      description: Nom de l'Ã©vÃ©nement pour un double clic (ex. "double" ou "2_double")
      default: "double"
      selector:
        text:

    event_triple:
      name: Ã‰vÃ©nement triple clic (optionnel)
      description: Laisser vide pour dÃ©sactiver le triple clic
      default: ""
      selector:
        text:

    event_long:
      name: Ã‰vÃ©nement appui long
      description: Nom de l'Ã©vÃ©nement pour un appui long (ex. "long_press" ou "hold")
      default: "long_press"
      selector:
        text:

    # ========================================
    # LUMINOSITÃ‰S (POURCENTAGES 0-100)
    # ========================================
    brightness_day:
      name: LuminositÃ© jour (dÃ©tecteur)
      description: LuminositÃ© pour dÃ©tection de jour (%)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    brightness_night:
      name: LuminositÃ© nuit (dÃ©tecteur)
      description: LuminositÃ© pour dÃ©tection de nuit (%)
      default: 30
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    brightness_single:
      name: LuminositÃ© simple clic
      description: LuminositÃ© pour simple clic - usage courant (%)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    brightness_double:
      name: LuminositÃ© double clic
      description: LuminositÃ© pour double clic - pleine puissance (%)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    brightness_triple:
      name: LuminositÃ© triple clic
      description: LuminositÃ© pour triple clic - veilleuse (%) - ignorÃ© si triple clic dÃ©sactivÃ©
      default: 11
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    brightness_min:
      name: LuminositÃ© minimale pour dimmer
      description: Seuil minimal avant extinction lors du dimming (%)
      default: 5
      selector:
        number:
          min: 1
          max: 20
          unit_of_measurement: "%"

    # ========================================
    # CONFIGURATION DIMMER
    # ========================================
    dim_step:
      name: Pas de variation du dimmer
      description: Pourcentage de variation Ã  chaque Ã©tape (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

    dim_interval:
      name: Intervalle de variation
      description: DÃ©lai entre chaque Ã©tape de variation (secondes)
      default: 0.5
      selector:
        number:
          min: 0.1
          max: 2
          step: 0.1
          unit_of_measurement: "s"

    # ========================================
    # TRANSITIONS
    # ========================================
    transition_on:
      name: Transition allumage
      description: DurÃ©e de transition Ã  l'allumage (secondes)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "s"

    transition_off_manual:
      name: Transition extinction manuelle
      description: DurÃ©e de transition pour extinction manuelle (secondes)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "s"

    transition_off_auto:
      name: Transition extinction automatique
      description: DurÃ©e de transition pour extinction automatique (secondes)
      default: 3
      selector:
        number:
          min: 0
          max: 30
          step: 0.5
          unit_of_measurement: "s"

    # ========================================
    # GESTION SOLAIRE
    # ========================================
    sunrise_offset:
      name: DÃ©calage lever du soleil
      description: Minutes aprÃ¨s (+) le lever du soleil pour passer en mode jour (dÃ©faut +30min)
      default: 30
      selector:
        number:
          min: -120
          max: 120
          unit_of_measurement: "min"

    sunset_offset:
      name: DÃ©calage coucher du soleil
      description: Minutes avant (-) le coucher du soleil pour passer en mode nuit (dÃ©faut -30min)
      default: -30
      selector:
        number:
          min: -120
          max: 120
          unit_of_measurement: "min"

    # ========================================
    # DEBUG
    # ========================================
    debug_notifications:
      name: Notifications debug
      description: Activer les notifications de debug (Ã  dÃ©sactiver en production)
      default: false
      selector:
        boolean:

# ============================================================================
# MODE
# ============================================================================
mode: queued
max: 10
max_exceeded: silent

# ============================================================================
# DÃ‰CLENCHEURS - VERSION UNIVERSELLE
# ============================================================================
trigger:
  # Trigger universel sur changement d'Ã©tat
  - platform: state
    entity_id: 
      - !input button_event
      - !input motion_sensor
    id: state_change

  # Trigger universel sur Ã©vÃ©nements
  - platform: event
    event_type: 
      - timer.finished
    id: timer_event

# ============================================================================
# CONDITIONS
# ============================================================================
condition:
  # Au moins un trigger valide doit Ãªtre configurÃ©
  - condition: or
    conditions:
      - "{{ button_valid }}"
      - "{{ motion_valid }}"
      - "{{ timer_auto_valid }}"
      - "{{ timer_manual_valid }}"

# ============================================================================
# VARIABLES
# ============================================================================
variables:
  # EntitÃ©s
  light: !input light_entity
  button_entity: !input button_event
  motion: !input motion_sensor
  auto_mode_entity: !input auto_mode_boolean
  source_bool_entity: !input lighting_source_boolean
  timer_auto_entity: !input timer_auto
  timer_manual_entity: !input timer_manual

  # Validation des entitÃ©s optionnelles
  button_valid: "{{ button_entity not in [none, '', 'unavailable', 'unknown'] }}"
  motion_valid: "{{ motion not in [none, '', 'unavailable', 'unknown'] }}"
  auto_mode_valid: "{{ auto_mode_entity not in [none, '', 'unavailable', 'unknown'] }}"
  source_bool_valid: "{{ source_bool_entity not in [none, '', 'unavailable', 'unknown'] }}"
  timer_auto_valid: "{{ timer_auto_entity not in [none, '', 'unavailable', 'unknown'] }}"
  timer_manual_valid: "{{ timer_manual_entity not in [none, '', 'unavailable', 'unknown'] }}"

  # Mode d'activation du dÃ©tecteur
  motion_mode: !input motion_activation_mode

  # Debug
  debug_enabled: !input debug_notifications

  # Ã‰vÃ©nements bouton
  event_single: !input event_single
  event_double: !input event_double
  event_triple: !input event_triple
  event_long: !input event_long

  # LuminositÃ©s (%)
  bright_day: !input brightness_day
  bright_night: !input brightness_night
  bright_single: !input brightness_single
  bright_double: !input brightness_double
  bright_triple: !input brightness_triple
  bright_min: !input brightness_min

  # Dimmer
  dim_step: !input dim_step
  dim_interval: !input dim_interval

  # Transitions
  trans_on: !input transition_on
  trans_off_manual: !input transition_off_manual
  trans_off_auto: !input transition_off_auto

  # Offsets solaires
  sunrise_off: !input sunrise_offset
  sunset_off: !input sunset_offset

  # Calcul pÃ©riode (jour/nuit) avec offsets
  # Sunrise : on ajoute l'offset (par dÃ©faut +30min = 30 minutes APRÃˆS le lever)
  # Sunset : on ajoute l'offset (par dÃ©faut -30min = 30 minutes AVANT le coucher)
  sunrise_time: "{{ as_timestamp(state_attr('sun.sun', 'next_rising')) + (sunrise_off * 60) }}"
  sunset_time: "{{ as_timestamp(state_attr('sun.sun', 'next_setting')) + (sunset_off * 60) }}"
  now_time: "{{ as_timestamp(now()) }}"
  is_day: "{{ now_time > sunrise_time and now_time < sunset_time }}"

  # VÃ©rification si le dÃ©tecteur doit Ãªtre actif selon le mode et la pÃ©riode
  motion_should_trigger: >
    {% if motion_mode == 'never' %}
      false
    {% elif motion_mode == 'always' %}
      true
    {% elif motion_mode == 'day_only' %}
      {{ is_day }}
    {% elif motion_mode == 'night_only' %}
      {{ not is_day }}
    {% else %}
      true
    {% endif %}

  # DÃ©tection du type de trigger
  trigger_type: >
    {% if trigger.platform == 'state' %}
      {% if trigger.entity_id == button_entity and button_valid %}
        button
      {% elif trigger.entity_id == motion and motion_valid %}
        motion
      {% else %}
        unknown
      {% endif %}
    {% elif trigger.platform == 'event' %}
      {% if trigger.event.data.entity_id == timer_auto_entity %}
        timer_auto
      {% elif trigger.event.data.entity_id == timer_manual_entity %}
        timer_manual
      {% else %}
        unknown
      {% endif %}
    {% else %}
      unknown
    {% endif %}

  # Helper pour rÃ©cupÃ©rer l'Ã©vÃ©nement bouton
  button_event_type: >
    {% if button_valid and trigger_type == 'button' %}
      {{ trigger.to_state.attributes.event_type | default('none') }}
    {% else %}
      none
    {% endif %}

# ============================================================================
# ACTIONS
# ============================================================================
action:
  # ====================================================================
  # DEBUG CONDITIONNEL
  # ====================================================================
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - action: persistent_notification.create
        data:
          title: "ðŸ” Debug Automation v3.5"
          message: |
            âš¡ Trigger:
              - Type: {{ trigger_type }}
              - Button event: {{ button_event_type }}
              - Platform: {{ trigger.platform }}
              - Entity: {{ trigger.entity_id | default('N/A') }}
            
            ðŸŽ›ï¸ Configuration:
              - Button valid: {{ button_valid }}
              - Motion valid: {{ motion_valid }}
              - Motion mode: {{ motion_mode }}
              - Motion should trigger: {{ motion_should_trigger }}
              - Auto mode enabled: {{ auto_mode_valid and is_state(auto_mode_entity, 'on') if auto_mode_valid else 'N/A' }}
            
            â˜€ï¸ PÃ©riode solaire:
              - Is day: {{ is_day }}
              - Sunrise offset: {{ sunrise_off }} min
              - Sunset offset: {{ sunset_off }} min
              - Sunrise time: {{ as_timestamp(state_attr('sun.sun', 'next_rising')) | timestamp_custom('%H:%M') }} â†’ {{ (sunrise_time) | timestamp_custom('%H:%M') }}
              - Sunset time: {{ as_timestamp(state_attr('sun.sun', 'next_setting')) | timestamp_custom('%H:%M') }} â†’ {{ (sunset_time) | timestamp_custom('%H:%M') }}
              - Current time: {{ now().strftime('%H:%M:%S') }}
            
            ðŸ’¡ LuminositÃ©s:
              - Single: {{ bright_single }}%
              - Double: {{ bright_double }}%
              - Triple: {{ bright_triple }}%
              - Day: {{ bright_day }}%
              - Night: {{ bright_night }}%
            
            â±ï¸ Timers:
              - Auto valid: {{ timer_auto_valid }}
              - Manual valid: {{ timer_manual_valid }}
              - Auto state: {{ states(timer_auto_entity) if timer_auto_valid else 'N/A' }}
              - Manual state: {{ states(timer_manual_entity) if timer_manual_valid else 'N/A' }}
            
            ðŸ”¦ Ã‰tat lumiÃ¨re:
              - State: {{ states(light) }}
              - Brightness: {{ state_attr(light, 'brightness') | int(0) }} ({{ (state_attr(light, 'brightness') | int(0) / 2.55) | round(1) }}%)

  # ====================================================================
  # LOGIQUE PRINCIPALE
  # ====================================================================
  - choose:
      # ====================================================================
      # DÃ‰TECTEUR DE MOUVEMENT
      # ====================================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger_type == 'motion' }}"
          # VÃ©rifier si le dÃ©tecteur doit Ãªtre actif selon le mode
          - condition: template
            value_template: "{{ motion_should_trigger }}"
          - condition: template
            value_template: "{{ auto_mode_valid }}"
          - condition: state
            entity_id: !input auto_mode_boolean
            state: "on"
        sequence:
          # Marquer la source comme "auto"
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_on
                target:
                  entity_id: !input lighting_source_boolean

          # Allumer avec luminositÃ© selon pÃ©riode
          - action: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: "{{ bright_night if not is_day else bright_day }}"
              transition: "{{ trans_on }}"

          # DÃ©marrer/RedÃ©marrer le timer auto
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto

              - action: timer.start
                target:
                  entity_id: !input timer_auto

      # ====================================================================
      # BOUTON - SIMPLE CLIC (Toggle + timer manuel) - 80%
      # ====================================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger_type == 'button' }}"
          - condition: template
            value_template: "{{ button_event_type == event_single }}"
        sequence:
          # Marquer la source comme "manuel"
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input lighting_source_boolean

          # Annuler le timer auto si actif
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto

          # Toggle la lumiÃ¨re
          - choose:
              # Si Ã©teinte â†’ allumer Ã  80%
              - conditions:
                  - condition: state
                    entity_id: !input light_entity
                    state: "off"
                sequence:
                  - action: light.turn_on
                    target:
                      entity_id: !input light_entity
                    data:
                      brightness_pct: "{{ bright_single }}"
                      transition: "{{ trans_on }}"

                  # DÃ©marrer le timer manuel
                  - if:
                      - condition: template
                        value_template: "{{ timer_manual_valid }}"
                    then:
                      - action: timer.start
                        target:
                          entity_id: !input timer_manual

            # Si allumÃ©e â†’ Ã©teindre
            default:
              - action: light.turn_off
                target:
                  entity_id: !input light_entity
                data:
                  transition: "{{ trans_off_manual }}"

              # Annuler le timer manuel
              - if:
                  - condition: template
                    value_template: "{{ timer_manual_valid }}"
                then:
                  - action: timer.cancel
                    target:
                      entity_id: !input timer_manual

      # ====================================================================
      # BOUTON - DOUBLE CLIC (Pleine puissance) - 100%
      # ====================================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger_type == 'button' }}"
          - condition: template
            value_template: "{{ button_event_type == event_double }}"
        sequence:
          # Marquer la source comme "manuel"
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input lighting_source_boolean

          # Annuler les timers
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto

          # Allumer Ã  100%
          - action: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: "{{ bright_double }}"
              transition: "{{ trans_on }}"

          # DÃ©marrer le timer manuel
          - if:
              - condition: template
                value_template: "{{ timer_manual_valid }}"
            then:
              - action: timer.start
                target:
                  entity_id: !input timer_manual

      # ====================================================================
      # BOUTON - TRIPLE CLIC (Veilleuse) - 11%
      # ====================================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger_type == 'button' }}"
          - condition: template
            value_template: "{{ event_triple != '' }}"
          - condition: template
            value_template: "{{ button_event_type == event_triple }}"
        sequence:
          # Marquer la source comme "manuel"
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input lighting_source_boolean

          # Annuler les timers
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto

          # Allumer Ã  11% (veilleuse)
          - action: light.turn_on
            target:
              entity_id: !input light_entity
            data:
              brightness_pct: "{{ bright_triple }}"
              transition: "{{ trans_on }}"

          # DÃ©marrer le timer manuel
          - if:
              - condition: template
                value_template: "{{ timer_manual_valid }}"
            then:
              - action: timer.start
                target:
                  entity_id: !input timer_manual

      # ====================================================================
      # BOUTON - APPUI LONG (Dimmer progressif)
      # ====================================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger_type == 'button' }}"
          - condition: template
            value_template: "{{ button_event_type == event_long }}"
        sequence:
          # Marquer la source comme "manuel"
          - if:
              - condition: template
                value_template: "{{ source_bool_valid }}"
            then:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input lighting_source_boolean

          # Annuler les timers
          - if:
              - condition: template
                value_template: "{{ timer_auto_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_auto

          - if:
              - condition: template
                value_template: "{{ timer_manual_valid }}"
            then:
              - action: timer.cancel
                target:
                  entity_id: !input timer_manual

          # Boucle de dimming
          - repeat:
              while:
                - condition: state
                  entity_id: !input light_entity
                  state: "on"
                - condition: template
                  value_template: "{{ (state_attr(light, 'brightness') | int(0) / 2.55) | int(0) > bright_min }}"
              sequence:
                - action: light.turn_on
                  target:
                    entity_id: !input light_entity
                  data:
                    brightness_step_pct: "{{ -dim_step }}"

                - delay:
                    seconds: "{{ dim_interval }}"

          # Si luminositÃ© minimale atteinte â†’ Ã©teindre
          - if:
              - condition: template
                value_template: "{{ (state_attr(light, 'brightness') | int(0) / 2.55) | int(0) <= bright_min }}"
            then:
              - action: light.turn_off
                target:
                  entity_id: !input light_entity
                data:
                  transition: "{{ trans_off_manual }}"

      # ====================================================================
      # FIN MINUTERIE MANUELLE
      # ====================================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger_type == 'timer_manual' }}"
        sequence:
          - action: light.turn_off
            target:
              entity_id: !input light_entity
            data:
              transition: "{{ trans_off_auto }}"

      # ====================================================================
      # FIN MINUTERIE AUTOMATIQUE
      # ====================================================================
      - conditions:
          - condition: template
            value_template: "{{ trigger_type == 'timer_auto' }}"
          - condition: template
            value_template: "{{ source_bool_valid }}"
          - condition: state
            entity_id: !input lighting_source_boolean
            state: "on"
        sequence:
          - action: light.turn_off
            target:
              entity_id: !input light_entity
            data:
              transition: "{{ trans_off_auto }}"
